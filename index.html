<!DOCTYPE html>
<html>
  <head>
    <title>Test Storage</title>

	<!-- jquery -->
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />	
	<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script> 
	<script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
	
	<!-- phonegap -->
    <script type="text/javascript" charset="utf-8" src="cordova-2.7.0.js"></script>
	
	<!--  code javascript -->
    <script type="text/javascript" charset="utf-8">

	//----------- init ----------
	
	//ajout declencheur evt init 
    document.addEventListener("deviceready", onDeviceReady, false);
	
	//EVT INITIALISATION DEVICE -> on apple fct initialisation
	function onDeviceReady() 
	{	
		//device ready -> on execute code initialisation
		InitialisationApplication();
    }
	
	//fct initilisation
	function InitialisationApplication()
	{
		//init affichage
		InitialisationAffichage();
		//init structure base de données
		//recuperation base de données
        var db = getDataBase();
		//on va verifier si la base de données existe -> sinon on va recréer les données		
        db.transaction(initStructureTable, errorInitStructureTable, successInitStructureTable);
	}
	
	//----------- base de données ------------
	
	//recuperation base de données
	function getDataBase()
	{
		db = window.openDatabase("Database", "1.0", "Cordova Demo", 200000);
		return db;
	}

	//----------------structure base ---------------------
	
	//methode princ
	function initStructureTable(tx) {
         //tx.executeSql('DROP TABLE IF EXISTS DEMO'); on ne supprime pas les données existantes
         tx.executeSql('CREATE TABLE IF NOT EXISTS DEMO (id unique, data)');
         //tx.executeSql('INSERT INTO DEMO (id, data) VALUES (1, "First row")');
         //tx.executeSql('INSERT INTO DEMO (id, data) VALUES (2, "Second row")');
    }

	//callback ERREUR 
    function errorInitStructureTable(tx, err) {
		//(ne devrait pas arriver)
        alert("Error processing SQL: "+err);
		InitialisationAffichage();
    }
	
	//callback OK -> on lance REFRESHAFFICHAGE
	function successInitStructureTable() {
        //alert("success!");
		RefreshAffichage();
    }
	
	//----------------- INIT AFFICHAGE -----------------------
	
	//nit affichage
	function InitialisationAffichage()
	{
		$("#idInsertNewitem").Hide();
		$("#idLstEnregistrement").html("Aucun enregistrement");
	}
	
	//-----------------REFRESH AFFICHAGE---------------------
	
	//procedure pricniaple refresh affichage
	function RefreshAffichage()
	{
		//execution recherche liste enreg
		var db = getDataBase();
        db.transaction(queryRefreshAffichage, errorQueryRefresh);
	}
	
	//fct exec query refresh
	function queryRefreshAffichage(tx) 
	{
        tx.executeSql('SELECT * FROM DEMO', [], successQueryRefresh, errorQueryRefresh);
    }
	
	//callback erreur refresh
	function errorQueryRefresh(tx, err) {
		//(ne devrait pas arriver)
        alert("Error processing SQL: "+err);
		//reinit affichage		
		InitialisationAffichage();
	}
	
	//callback ok
	function successQueryRefresh()
	{
		//query select ok -> recup lst enregs
		var len = results.rows.length;
		var html = "";
		for (var i=0; i<len; i++)
		{
			var objid=results.rows.item(i).id;
			var objdata=results.rows.item(i).data;
			html=html+" "+objid+" "+objdata+"<br/>";
		}		
		//affichage
		$("#idLstEnregistrement").html(html);
		//on affichage le formulaire insertion
		$("#idInsertNewitem").show();
	}
	
	//---------------insertion nouvel erneg ---------------
	
	function InsertionEnregistrement()
	{
		alert("insert");
	}
		

    </script>
  </head>
  
  
  <body>
    <h1>Test storage</h1>
    <p>Database</p>
	
	<div id="idInsertNewitem" style="display:none">
	  <form>
		<label> Nouvelle Reference </label>
		<input type="text" id="idReferenceInput" name="idReferenceInput">
		<input type="button" value="Inserer" onClick=javascript:InsertionEnregistrement()> 
	  </form>
	</div>
	
	<div id="idLstEnregistrement" style="display:block">
	  Aucun enregistrement<br/>
	</div>
	
	<p>end</p>
  </body>
</html>